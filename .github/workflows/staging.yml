name: Staging Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # =============================================================================
  # JOB 1: Test (always runs)
  # =============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run smoke tests (in-memory)
        run: npm run smoke:mvp

  # =============================================================================
  # JOB 2: Migrate Staging DB (push to main only)
  # =============================================================================
  migrate_staging:
    name: Migrate Staging DB
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
        run: npm run db:migrate:staging

  # =============================================================================
  # JOB 3: Deploy to Vercel (push to main only)
  # =============================================================================
  deploy_staging:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: migrate_staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Staging
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOYMENT_URL"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}

  # =============================================================================
  # JOB 4: Healthz Gate (push to main only)
  # =============================================================================
  healthz_gate:
    name: Healthz Gate
    runs-on: ubuntu-latest
    needs: deploy_staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Wait for deployment to be ready
        run: sleep 30

      - name: Check healthz endpoint
        run: |
          echo "Checking ${{ secrets.STAGING_URL }}/api/healthz"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.STAGING_URL }}/api/healthz")
          if [ "$RESPONSE" != "200" ]; then
            echo "Healthz check failed with status: $RESPONSE"
            exit 1
          fi
          echo "Healthz check passed (200)"

  # =============================================================================
  # JOB 5: Auth Required Gate (push to main only)
  # Verifies protected endpoints return 401 WITHOUT auth token
  # =============================================================================
  auth_required_gate:
    name: Auth Required Gate (401)
    runs-on: ubuntu-latest
    needs: healthz_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify endpoints require auth (expect 401)
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
        run: npm run auth:sanity:require401

  # =============================================================================
  # JOB 6: Auth Works Gate (push to main only)
  # Verifies protected endpoints return 200 WITH valid auth token
  # =============================================================================
  auth_works_gate:
    name: Auth Works Gate (200)
    runs-on: ubuntu-latest
    needs: auth_required_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify endpoints work with auth (expect 200)
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
          STAGING_AUTH_TOKEN: ${{ secrets.STAGING_AUTH_TOKEN }}
        run: npm run auth:sanity:require200

  # =============================================================================
  # JOB 7: Runtime Flags Gate (push to main only)
  # Proves DB runtime flags actually change live behavior
  # =============================================================================
  runtime_flags_gate:
    name: Runtime Flags Gate
    runs-on: ubuntu-latest
    needs: auth_works_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Prove runtime flags work
        env:
          DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
          STAGING_URL: ${{ secrets.STAGING_URL }}
          STAGING_AUTH_TOKEN: ${{ secrets.STAGING_AUTH_TOKEN }}
        run: npm run flags:proof

  # =============================================================================
  # JOB 8: Readonly Mode Gate (push to main only)
  # Proves readonly mode prevents DB writes while maintaining valid responses
  # =============================================================================
  readonly_gate:
    name: Readonly Mode Gate
    runs-on: ubuntu-latest
    needs: runtime_flags_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Prove readonly mode works
        env:
          DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
          STAGING_URL: ${{ secrets.STAGING_URL }}
          STAGING_AUTH_TOKEN: ${{ secrets.STAGING_AUTH_TOKEN }}
        run: npm run readonly:proof

  # =============================================================================
  # JOB 9: Smoke Test Staging (push to main only)
  # =============================================================================
  smoke_staging:
    name: Smoke Test Staging
    runs-on: ubuntu-latest
    needs: readonly_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run staging smoke tests
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
          STAGING_AUTH_TOKEN: ${{ secrets.STAGING_AUTH_TOKEN }}
        run: npm run smoke:staging

      - name: Contract compliance summary
        run: |
          echo "=== Contract Compliance ==="
          echo "All canonical response shapes validated:"
          echo "  - Decision: { decision, drmRecommended, reason?, autopilot? }"
          echo "  - DRM: { drmActivated }"
          echo "  - Feedback: { recorded: true }"
          echo "  - Receipt: { receiptImportId, status }"
          echo "=== PASSED ==="
