name: Staging Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # =============================================================================
  # JOB 1: Test (always runs)
  # =============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run smoke tests (in-memory)
        run: npm run smoke:mvp

  # =============================================================================
  # JOB 2: Migrate Staging DB (push to main only)
  # =============================================================================
  migrate_staging:
    name: Migrate Staging DB
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
        run: npm run db:migrate:staging

      - name: Verify tables exist
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
        run: |
          echo "Migration completed. Tables verified by migrate script output above."
          echo "Expected tables: user_profiles, meals, decision_events, taste_signals, taste_meal_scores, receipt_imports, inventory_items, households, household_members"

  # =============================================================================
  # JOB 3: Deploy to Vercel (push to main only)
  # =============================================================================
  deploy_staging:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: migrate_staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Staging
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOYMENT_URL"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}

  # =============================================================================
  # JOB 4: Smoke Test Staging (push to main only)
  # =============================================================================
  smoke_staging:
    name: Smoke Test Staging
    runs-on: ubuntu-latest
    needs: deploy_staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for deployment to be ready
        run: sleep 30

      - name: Run staging smoke tests
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
          STAGING_AUTH_TOKEN: ${{ secrets.STAGING_AUTH_TOKEN }}
        run: npm run smoke:staging

      - name: Verify contract compliance
        run: |
          echo "=== Contract Compliance Check ==="
          echo "Smoke tests verify:"
          echo "  - Decision response: { decision, drmRecommended, reason?, autopilot? }"
          echo "  - DRM response: { drmActivated }"
          echo "  - Feedback response: { recorded: true }"
          echo "  - Receipt response: { receiptImportId, status }"
          echo "All validators from lib/decision-os/invariants.ts are enforced."
          echo "=== PASSED ==="
