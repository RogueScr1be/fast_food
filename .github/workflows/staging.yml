name: Staging Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Weekly metrics prune: Sunday at 03:00 UTC
    - cron: '0 3 * * 0'

env:
  NODE_VERSION: '20'

jobs:
  # =============================================================================
  # JOB 1: Test (always runs)
  # =============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run smoke tests (in-memory)
        run: npm run smoke:mvp

  # =============================================================================
  # JOB 2: Deploy Freeze Gate (push to main only)
  # Emergency brake - set STAGING_DEPLOY_ENABLED=false in GitHub secrets to freeze
  # =============================================================================
  deploy_freeze_gate:
    name: Deploy Freeze Gate
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Check deploy freeze status
        env:
          STAGING_DEPLOY_ENABLED: ${{ secrets.STAGING_DEPLOY_ENABLED }}
        run: |
          # Default to "true" if not set (allows deploys by default)
          ENABLED="${STAGING_DEPLOY_ENABLED:-true}"
          
          if [ "$ENABLED" != "true" ]; then
            echo "::error::Deploys frozen by STAGING_DEPLOY_ENABLED"
            echo "FAIL deploys_frozen"
            exit 1
          fi
          
          echo "PASS deploy_enabled"

  # =============================================================================
  # JOB 3: Migrate Staging DB (push to main only)
  # =============================================================================
  migrate_staging:
    name: Migrate Staging DB
    runs-on: ubuntu-latest
    needs: deploy_freeze_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
        run: npm run db:migrate:staging

  # =============================================================================
  # JOB 4: Schema Gate (push to main only)
  # Verifies staging DB schema matches required structure
  # =============================================================================
  schema_gate:
    name: Schema Gate
    runs-on: ubuntu-latest
    needs: migrate_staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify schema
        env:
          DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
        run: npm run db:verify:staging

  # =============================================================================
  # JOB 5: Deploy to Vercel (push to main only)
  # =============================================================================
  deploy_staging:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: schema_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Vercel Pull
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Vercel Build
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Vercel Deploy
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment_url=$url" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Validate URL format
        run: |
          echo "${{ steps.deploy.outputs.deployment_url }}" | grep -qE '^https://[a-z0-9-]+\.vercel\.app$'
          if [ $? -ne 0 ]; then
            echo "FAIL invalid_deployment_url_format"
            exit 1
          fi
          echo "PASS url_validated"

  # =============================================================================
  # JOB 6: Healthz Gate (push to main only)
  # =============================================================================
  healthz_gate:
    name: Healthz Gate
    runs-on: ubuntu-latest
    needs: deploy_staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Wait for deployment to be ready
        run: sleep 30

      - name: Check healthz endpoint
        run: |
          echo "Checking ${{ secrets.STAGING_URL }}/api/healthz"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.STAGING_URL }}/api/healthz")
          if [ "$RESPONSE" != "200" ]; then
            echo "Healthz check failed with status: $RESPONSE"
            exit 1
          fi
          echo "Healthz check passed (200)"

  # =============================================================================
  # JOB 7: Metrics Health Gate (push to main only)
  # Verifies runtime_metrics_daily table exists and is queryable
  # =============================================================================
  metrics_gate:
    name: Metrics Health Gate
    runs-on: ubuntu-latest
    needs: healthz_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check metrics health
        env:
          DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
        run: npm run metrics:health

  # =============================================================================
  # JOB 8: Alerts Gate (push to main only)
  # Checks durable metrics for alert thresholds
  # =============================================================================
  alerts_gate:
    name: Alerts Gate
    runs-on: ubuntu-latest
    needs: metrics_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check metrics alerts
        env:
          DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
        run: npm run metrics:alerts

  # =============================================================================
  # JOB 9: Auth Required Gate (push to main only)
  # Verifies protected endpoints return 401 WITHOUT auth token
  # =============================================================================
  auth_required_gate:
    name: Auth Required Gate (401)
    runs-on: ubuntu-latest
    needs: alerts_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify endpoints require auth (expect 401)
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
        run: npm run auth:sanity:require401

  # =============================================================================
  # JOB 10: Auth Works Gate (push to main only)
  # Verifies protected endpoints return 200 WITH valid auth token
  # =============================================================================
  auth_works_gate:
    name: Auth Works Gate (200)
    runs-on: ubuntu-latest
    needs: auth_required_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify endpoints work with auth (expect 200)
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
          STAGING_AUTH_TOKEN: ${{ secrets.STAGING_AUTH_TOKEN }}
        run: npm run auth:sanity:require200

  # =============================================================================
  # JOB 11: Runtime Flags Gate (push to main only)
  # Proves DB runtime flags actually change live behavior
  # =============================================================================
  runtime_flags_gate:
    name: Runtime Flags Gate
    runs-on: ubuntu-latest
    needs: auth_works_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Prove runtime flags work
        env:
          DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
          STAGING_URL: ${{ secrets.STAGING_URL }}
          STAGING_AUTH_TOKEN: ${{ secrets.STAGING_AUTH_TOKEN }}
        run: npm run flags:proof

  # =============================================================================
  # JOB 12: Readonly Mode Gate (push to main only)
  # Proves readonly mode prevents DB writes while maintaining valid responses
  # =============================================================================
  readonly_gate:
    name: Readonly Mode Gate
    runs-on: ubuntu-latest
    needs: runtime_flags_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Prove readonly mode works
        env:
          DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
          STAGING_URL: ${{ secrets.STAGING_URL }}
          STAGING_AUTH_TOKEN: ${{ secrets.STAGING_AUTH_TOKEN }}
        run: npm run readonly:proof

  # =============================================================================
  # JOB 13: Smoke Test Staging (push to main only)
  # =============================================================================
  smoke_staging:
    name: Smoke Test Staging
    runs-on: ubuntu-latest
    needs: readonly_gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run staging smoke tests
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
          STAGING_AUTH_TOKEN: ${{ secrets.STAGING_AUTH_TOKEN }}
        run: npm run smoke:staging

      - name: Contract compliance summary
        run: |
          echo "=== Contract Compliance ==="
          echo "All canonical response shapes validated:"
          echo "  - Decision: { decision, drmRecommended, reason?, autopilot? }"
          echo "  - DRM: { drmActivated }"
          echo "  - Feedback: { recorded: true }"
          echo "  - Receipt: { receiptImportId, status }"
          echo "=== PASSED ==="

  # =============================================================================
  # JOB 14: Record Last Green (push to main only)
  # Records successful deployment to runtime_deployments_log for rollback support
  # =============================================================================
  record_last_green:
    name: Record Last Green
    runs-on: ubuntu-latest
    needs: smoke_staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Record last green deployment
        env:
          DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
          DEPLOYMENT_URL: ${{ needs.deploy_staging.outputs.deployment_url }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          ENV_NAME: staging
        run: npm run deploy:record:lastgreen

  # =============================================================================
  # JOB 15: Provenance Gate (push to main only)
  # Verifies recorded deployment matches actual deployment
  # =============================================================================
  provenance_gate:
    name: Provenance Gate
    runs-on: ubuntu-latest
    needs: record_last_green
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify provenance
        env:
          DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
          EXPECTED_DEPLOYMENT_URL: ${{ needs.deploy_staging.outputs.deployment_url }}
          ENV_NAME: staging
        run: npm run deploy:provenance:proof

  # =============================================================================
  # JOB: Weekly Metrics Prune (scheduled only)
  # Deletes old metrics to prevent unbounded DB growth
  # =============================================================================
  metrics_prune:
    name: Weekly Metrics Prune
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Prune old metrics
        env:
          DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
          METRICS_RETENTION_DAYS: '90'
        run: npm run metrics:prune
