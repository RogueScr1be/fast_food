# Staging Deploy + Verify Workflow
#
# Manual dispatch (safest default). Can also trigger on push to main.
# Uses GitHub Environment: staging (for scoped secrets)
#
# Steps:
# 1. Tests + build sanity (fail fast)
# 2. Migrate staging DB
# 3. Deploy to Vercel staging
# 4. Run staging healthcheck

name: Staging Deploy + Verify

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy (branch, tag, sha)"
        required: true
        default: "main"

concurrency:
  group: staging-deploy
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  # Force Node to prefer IPv4 over IPv6 to avoid Supabase pooler AAAA -> ENETUNREACH on GitHub runners
  NODE_OPTIONS: --dns-result-order=ipv4first

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Fail fast if tests are broken
      - name: Run tests
        run: npm test

      - name: Build sanity check
        run: npm run build:sanity

      # DB migrate + verify
      - name: Migrate staging DB
        env:
          NODE_OPTIONS: --dns-result-order=ipv4first
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}&uselibpqcompat=true
        run: |
          echo "=== Migrating Staging DB ==="
          npm run db:migrate:staging
          echo "PASS migrations_applied"

      - name: Verify staging DB schema
        env:
          NODE_OPTIONS: --dns-result-order=ipv4first
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}&uselibpqcompat=true
        run: |
          echo "=== Verifying Staging Schema ==="
          npm run db:verify:staging
          echo "PASS schema_verified"

      - name: Secrets sanity (no leak)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          set -euo pipefail
          echo "=== Secrets Sanity ==="
          [ -n "${VERCEL_TOKEN:-}" ] || (echo "MISSING: VERCEL_TOKEN" && exit 1)
          [ -n "${VERCEL_ORG_ID:-}" ] || (echo "MISSING: VERCEL_ORG_ID" && exit 1)
          [ -n "${VERCEL_PROJECT_ID:-}" ] || (echo "MISSING: VERCEL_PROJECT_ID" && exit 1)
          echo "OK: secrets present (token/org/project)"
          echo "org_len=${#VERCEL_ORG_ID} project_len=${#VERCEL_PROJECT_ID}"

            # Vercel deploy
      - name: Deploy to Vercel (staging)
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }} # Vercel Team SLUG or your username, not necessarily an "ID"
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }} # used only for verification
        run: |
          set -euo pipefail
          echo "=== Deploying to Vercel ==="
          npx vercel --version

          # Hard fail if any required secret is missing
          [ -n "${VERCEL_TOKEN:-}" ] || (echo "MISSING: VERCEL_TOKEN" && exit 1)
          [ -n "${VERCEL_ORG_ID:-}" ] || (echo "MISSING: VERCEL_ORG_ID" && exit 1)
          [ -n "${VERCEL_PROJECT_ID:-}" ] || (echo "MISSING: VERCEL_PROJECT_ID" && exit 1)

          echo "=== Linking repo to Vercel project ==="
          # This writes .vercel/project.json based on the linked project for this repo under the given scope
          npx vercel pull --yes --environment=preview --token="$VERCEL_TOKEN" --scope="$VERCEL_ORG_ID"

          if [ ! -f ".vercel/project.json" ]; then
            echo "FAIL: .vercel/project.json not created. Repo not linked."
            exit 1
          fi

          echo "=== Verifying linked project ==="
          cat .vercel/project.json
          LINKED_PROJECT_ID=$(node -e "console.log(require('./.vercel/project.json').projectId || '')")
          if [ -z "$LINKED_PROJECT_ID" ]; then
            echo "FAIL: linked projectId missing in .vercel/project.json"
            exit 1
          fi

          # Enforce “no phantom project”: the linked project must equal what you think it is
          if [ "$LINKED_PROJECT_ID" != "$VERCEL_PROJECT_ID" ]; then
            echo "FAIL: Repo linked to unexpected Vercel project."
            echo "Linked projectId: $LINKED_PROJECT_ID"
            echo "Expected projectId: $VERCEL_PROJECT_ID"
            echo ""
            echo "Fix: In Vercel UI, open the project you WANT, and import/link this GitHub repo to that project."
            echo "Then re-run. (The link is what determines project binding in CI.)"
            exit 1
          fi
          echo "PASS linked to expected projectId=$LINKED_PROJECT_ID"

          echo "=== Building ==="
          npx vercel build --token="$VERCEL_TOKEN" --scope="$VERCEL_ORG_ID"

          echo "=== Deploying ==="
          url=$(npx vercel deploy --prebuilt --token="$VERCEL_TOKEN" --scope="$VERCEL_ORG_ID")

          echo "deployment_url=$url" >> $GITHUB_OUTPUT
          echo "PASS deployed to $url"

  healthcheck:
    name: Staging Healthcheck
    runs-on: ubuntu-latest
    needs: deploy
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run staging healthcheck
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
          STAGING_AUTH_TOKEN: ${{ secrets.STAGING_AUTH_TOKEN }}
        run: |
          echo "=== Running Staging Healthcheck ==="
          npm run staging:healthcheck
          echo "PASS staging_healthcheck"

      - name: Record deployment (last green)
        env:
          # EDIT: deploy:record:lastgreen expects DATABASE_URL (not DATABASE_URL_STAGING)
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
          DEPLOYMENT_URL: ${{ needs.deploy.outputs.deployment_url }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          ENV_NAME: staging
        run: |
          echo "=== Recording Last Green Deployment ==="
          npm run deploy:record:lastgreen

  summary:
    name: Staging Summary
    runs-on: ubuntu-latest
    needs: [deploy, healthcheck]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "=== Staging Deploy Summary ==="
          echo "Ref: ${{ inputs.ref }}"
          echo "Deploy status: ${{ needs.deploy.result }}"
          echo "Healthcheck status: ${{ needs.healthcheck.result }}"
          if [ "${{ needs.healthcheck.result }}" == "success" ]; then
            echo ""
            echo "✅ STAGING IS GREEN"
            echo "You may proceed with: Release to TestFlight workflow"
          else
            echo ""
            echo "❌ STAGING FAILED"
            echo "Do NOT proceed with release until staging is green."
          fi
